---
ws_id: 00-050-02
parent: sdp-79u
feature: F050
status: completed
size: MEDIUM
project_id: 00
---

# Depends handled by parent epic sdp-79u
---

## WS-00-050-02: TDD Runner

### üéØ Goal

Implement Red-Green-Refactor cycle automation with language detection (Python, Go, Java). Enable automated test execution with phase tracking and error reporting.

**What must WORK after completing this WS:**
- Red phase runs tests, expects failure
- Green phase runs tests, expects success
- Refactor phase runs tests, ensures no regression
- Language detection: pytest (Python), go test (Go), mvn test (Java)
- Commands: `sdp tdd red`, `sdp tdd green`, `sdp tdd refactor`
- Context cancellation support

**Acceptance Criteria:**
- [ ] AC1: Red phase runs tests, expects failure (returncode != 0)
- [ ] AC2: Green phase runs tests, expects success (returncode == 0)
- [ ] AC3: Refactor phase runs tests, ensures no regression
- [ ] AC4: Language detection (pytest/go test/mvn)
- [ ] AC5: Phase transition tracking
- [ ] AC6: Context cancellation stops execution
- [ ] AC7: Commands work: `sdp tdd red/green/refactor`
- [ ] Coverage ‚â• 80%

**‚ö†Ô∏è WS is NOT complete until Goal is achieved (all AC ‚úÖ).**

---

### üìã Contracts

**Technical Constraints:**
- Must use os/exec for test execution
- Must capture stdout/stderr separately
- Must support context.Context for cancellation
- Must return structured errors (phase + cause)

**Builds on F041:**
- ‚úÖ `sdp-plugin/go.mod` exists
- ‚úÖ `sdp-plugin/cmd/sdp/main.go` exists
- üÜï Add `internal/tdd/` package

---

### üîå Interfaces

```go
package tdd

type Phase int

const (
    Red Phase = iota
    Green
    Refactor
)

type Language int

const (
    Python Language = iota
    Go
    Java
)

type Runner struct {
    language Language
    testCmd  string
}

func (r *Runner) DetectLanguage() (Language, error)
func (r *Runner) RunPhase(ctx context.Context, phase Phase, wsPath string) (*PhaseResult, error)
func (r *Runner) RunAllPhases(ctx context.Context, wsPath string) ([]*PhaseResult, error)

type PhaseResult struct {
    Phase    Phase
    Success  bool
    Duration time.Duration
    Stdout   string
    Stderr   string
    Error    error
}
```

---

### üìÅ Scope Files

**Implementation:**
- `internal/tdd/runner.go` (NEW)
- `internal/tdd/phase.go` (NEW)
- `internal/tdd/language.go` (NEW - detector)
- `cmd/sdp/tdd.go` (NEW - CLI command)

**Tests:**
- `internal/tdd/runner_test.go` (NEW)
- `internal/tdd/language_test.go` (NEW)

---

### ‚úÖ Testing

**Unit Tests:**
```bash
# Red phase execution
TestRedPhaseFails()

# Green phase execution
TestGreenPhaseSucceeds()

# Refactor phase execution
TestRefactorPhasePasses()

# Language detection
TestDetectPythonProject()
TestDetectGoProject()
TestDetectJavaProject()

# Context cancellation
TestContextCancellation()
```

**Integration Tests:**
```bash
# Python project
cd tests/test-python
../../sdp tdd red
../../sdp tdd green
../../sdp tdd refactor

# Go project
cd tests/test-go
../../sdp tdd red
../../sdp tdd green
```

---

### üîç Verification

**Pre-build:**
- [ ] Review test command construction for each language
- [ ] Verify context cancellation logic
- [ ] Check error propagation

**Post-build:**
```bash
cd sdp-plugin

# Run tests
go test ./internal/tdd/... -v -cover

# Build binary
go build ./cmd/sdp

# Test Python project
cd ../tests/test-python
../../sdp tdd red    # Expected: failure
../../sdp tdd green  # Expected: success
../../sdp tdd refactor # Expected: no regression
```

---

### üìù Notes

**Dependencies:** 00-050-01 (uses Workstream struct)

**Context:**
TDD runner is core to SDP workflow. Simplified from Python (800 LOC ‚Üí 400 LOC). Context cancellation enables @oneshot to stop mid-execution.

**Key Decisions:**
- os/exec for subprocess management (standard library)
- Language detection via project files (pyproject.toml, go.mod, pom.xml)
- Separate stdout/stderr capture (better error messages)
- Context cancellation (Go best practice)

**Risks:**
- Test runner not installed (pytest, go, mvn)
- Unexpected exit codes from test runners
- Context doesn't propagate to subprocess

**Mitigations:**
- Detect test runner in PATH before execution
- Validate exit codes per runner
- Use cmd.Process.Kill() for forceful termination

**Integration:**
- Used by: @build skill, Orchestrator (00-050-11)
- Provides: Automated test execution for TDD cycle

---

## üìä Execution Report

**Execution Date:** 2026-02-05  
**Implementation Location:** `sdp-plugin/internal/tdd/`  
**Git Commit:** 651aed4 feat(tdd): implement TDD Runner (00-050-02)

### Acceptance Criteria Status

- ‚úÖ AC1: Red phase runs tests, expects failure (returncode != 0)
- ‚úÖ AC2: Green phase runs tests, expects success (returncode == 0)
- ‚úÖ AC3: Refactor phase runs tests, ensures no regression
- ‚úÖ AC4: Language detection (pytest/go test/mvn)
- ‚úÖ AC5: Phase transition tracking
- ‚úÖ AC6: Context cancellation stops execution
- ‚úÖ AC7: Commands work: `sdp tdd red/green/refactor`
- ‚úÖ Coverage ‚â• 80%

### Implementation Details

**Files Created:**
- `internal/tdd/runner.go` - Main TDD runner implementation
- `internal/tdd/phase.go` - Phase constants and tracking
- `internal/tdd/language.go` - Language detection logic
- `internal/tdd/context.go` - Context cancellation support
- `cmd/sdp/tdd.go` - CLI commands for TDD
- `internal/tdd/runner_test.go` - Comprehensive tests
- `internal/tdd/language_test.go` - Language detection tests

**Key Features:**
- Red-Green-Refactor cycle automation
- Language detection: pytest (Python), go test (Go), mvn test (Java)
- Context cancellation support for graceful shutdown
- Separate stdout/stderr capture for debugging
- Phase transition tracking with detailed results
- Commands: `sdp tdd red`, `sdp tdd green`, `sdp tdd refactor`

**Test Results:**
- Unit tests: All passing
- Coverage: 82.7%
- Integration tests: Tested with Python and Go projects

**Integration:**
- Used by: @build skill, Orchestrator (00-050-11)
- Provides: Automated test execution for TDD cycle

**Status:** ‚úÖ COMPLETE - All acceptance criteria met
