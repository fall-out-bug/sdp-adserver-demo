# 00-052-12: Parallel Dispatcher for @oneshot

## Metadata
- **ws_id**: 00-052-12
- **project_id**: 00
- **feature_id**: 052
- **title**: Parallel Dispatcher for @oneshot
- **status**: in_progress
- **priority**: P1
- **dependencies**: 00-052-11
- **estimated_days**: 5-7
- **complexity**: LARGE

## Goal
Execute workstreams in parallel using dependency graph for @oneshot orchestrator

## Scope

### Files to Modify
- `.claude/skills/oneshot/SKILL.md` - Update workflow for parallel execution

### Files to Create
- `src/sdp/graph/dependency.go` - Dependency graph data structures
- `src/sdp/graph/topological.go` - Kahn's algorithm implementation
- `tests/sdp/graph/test_dependency.go` - TDD tests for graph algorithms

## Acceptance Criteria

### AC1: Build Dependency Graph from WS Files
- Parse all WS files in feature directory
- Extract `depends_on` field from frontmatter
- Build directed acyclic graph (DAG) with nodes (WS) and edges (dependencies)
- Detect and reject circular dependencies

### AC2: Kahn's Algorithm for Topological Sort
- Implement Kahn's algorithm for topological sorting
- Return ordered list of WS respecting dependencies
- Handle edge cases: single WS, empty list, circular dependencies

### AC3: Execute Ready WS in Parallel
- Identify ready-to-execute WS (no pending dependencies)
- Spawn 3-5 parallel agents via Task tool
- Distribute ready WS among available agents
- Track completion and update graph state

### AC4: Speedup Target
- 1 WS: Sequential (baseline)
- 5 WS: 3x speedup vs sequential
- 10 WS: 5x speedup vs sequential

## Algorithm

1. **Parse Phase**: Read all WS files in feature directory
2. **Graph Phase**: Build DAG with WS as nodes, dependencies as edges
3. **Sort Phase**: Topological sort to find execution order
4. **Execute Phase**:
   - Identify ready WS (indegree = 0)
   - Spawn parallel agents (3-5 Task tool calls)
   - Distribute WS among agents
   - Wait for completion
5. **Update Phase**: Remove completed WS from graph, recalculate indegrees
6. **Repeat**: Until all WS completed

## Implementation Notes

### Go Data Structures
```go
type DependencyGraph struct {
    nodes map[string]*WorkstreamNode
    edges map[string][]string  // node -> dependents
}

type WorkstreamNode struct {
    ID          string
    DependsOn   []string
    Indegree    int
    Completed   bool
}

func (g *DependencyGraph) TopologicalSort() ([]string, error)
func (g *DependencyGraph) GetReady() []string
func (g *DependencyGraph) MarkComplete(id string)
```

### Agent Coordination
- Use Task tool with subagent_type="builder"
- Run in background for parallel execution
- Poll for completion via TaskOutput tool
- Limit concurrency to 3-5 agents

### Error Handling
- Circular dependency: Fatal error, reject feature
- Agent failure: Log error, mark WS as failed, continue with others
- Partial completion: Save checkpoint, allow resume

## Testing Strategy

### Unit Tests (TDD)
- Test graph construction from WS files
- Test topological sort with known DAGs
- Test circular dependency detection
- Test ready node identification

### Integration Tests
- Test 5 WS execution with dependencies
- Verify 3x speedup vs sequential
- Test checkpoint/resume after partial completion
- Test error handling (agent failure)

## Definition of Done
- [ ] All AC verified with tests
- [ ] Unit tests â‰¥80% coverage
- [ ] Integration tests pass
- [ ] @oneshot skill updated with parallel workflow
- [ ] Documentation updated in CLAUDE.md
- [ ] Git commit with conventional commit message
