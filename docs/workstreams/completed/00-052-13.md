# 00-052-13: Circuit Breaker for @oneshot

## Metadata
- **ws_id**: 00-052-13
- **project_id**: 00
- **feature_id**: 052
- **title**: Circuit Breaker for @oneshot
- **status**: in_progress
- **priority**: P1
- **dependencies**: 00-052-12
- **estimated_days**: 2-3
- **complexity**: MEDIUM

## Goal
Implement Circuit Breaker pattern to prevent cascading failures when agents fail during parallel workstream execution

## Scope

### Files to Modify
- `src/sdp/graph/dispatcher.go` - Integrate circuit breaker into dispatcher

### Files to Create
- `src/sdp/graph/circuit_breaker.go` - Circuit breaker state machine
- `tests/sdp/graph/circuit_breaker_test.go` - TDD tests for circuit breaker

## Acceptance Criteria

### AC1: Implement 3-State Circuit Breaker
- **CLOSED**: Normal operation, track failures
- **OPEN**: Reject requests, wait for timeout
- **HALF_OPEN**: Allow one test request, reset on success

### AC2: Threshold-Based Tripping
- Trip to OPEN after N failures in M requests
- Configurable threshold (default: 3 failures)
- Configurable window (default: 5 requests)

### AC3: Automatic Recovery with Backoff
- After timeout, transition OPEN → HALF_OPEN
- Allow one test request in HALF_OPEN
- Success → CLOSED, reset failure count
- Failure → back to OPEN with exponential backoff

### AC4: Integration with Dispatcher
- Wrap agent execution with circuit breaker
- Reject execution attempts when OPEN
- Log state transitions for observability
- Provide metrics (state, failures, last error)

## Circuit Breaker States

```go
type CircuitState int

const (
    StateClosed   CircuitState = iota  // Normal operation
    StateOpen                           // Failing, reject requests
    StateHalfOpen                       // Testing recovery
)
```

### State Transitions

```
CLOSED ──[failures ≥ threshold]──> OPEN
  ▲                                   │
  │                                   │ [timeout + backoff]
  │ [success]                         │
  │                                   ▼
  └──────── HALF_OPEN <──────────────┘
              │
              └─[failure]──> OPEN
```

### Behavior by State

**CLOSED:**
- Allow all requests
- Track consecutive failures
- Track success rate
- Trip to OPEN if threshold exceeded

**OPEN:**
- Reject all requests immediately
- Return ErrCircuitBreakerOpen
- Wait for timeout + backoff
- Transition to HALF_OPEN after timeout

**HALF_OPEN:**
- Allow ONE test request
- Success → CLOSED, reset counters
- Failure → OPEN, increase backoff

## Implementation Notes

### Go Data Structures

```go
type CircuitBreaker struct {
    mu                sync.RWMutex
    state             CircuitState
    failureCount      int
    successCount      int
    lastFailureTime   time.Time
    threshold         int  // failures to trip
    window            int  // request window
    timeout           time.Duration
    backoff           time.Duration
    consecutiveOpens  int  // for exponential backoff
}

type CircuitBreakerConfig struct {
    Threshold  int           // Default: 3
    Window     int           // Default: 5
    Timeout    time.Duration // Default: 60s
    MaxBackoff time.Duration // Default: 5min
}

func NewCircuitBreaker(config CircuitBreakerConfig) *CircuitBreaker
func (cb *CircuitBreaker) Execute(fn func() error) error
func (cb *CircuitBreaker) State() CircuitState
func (cb *CircuitBreaker) Metrics() CircuitBreakerMetrics
```

### Integration with Dispatcher

```go
type Dispatcher struct {
    // ... existing fields ...
    circuitBreaker *CircuitBreaker
}

func (d *Dispatcher) Execute(execFn ExecuteFunc) []ExecuteResult {
    // Wrap each workstream execution with circuit breaker
    for _, wsID := range ready {
        result := d.circuitBreaker.Execute(func() error {
            return execFn(wsID)
        })
        // ... handle result
    }
}
```

### Error Handling

**Count as failure:**
- Agent timeout (>10 minutes)
- Agent panic/crash
- Network errors
- Task tool returns error
- Workstream test failures

**Reset on success:**
- Workstream completes successfully
- All tests pass
- Quality gates pass

### Backoff Strategy

```go
backoff = min(baseTimeout * (2 ^ consecutiveOpens), maxBackoff)

// Example:
// Open 1: 60s
// Open 2: 120s
// Open 3: 240s
// Open 4: 480s (5min max)
```

### Logging and Metrics

```go
type CircuitBreakerMetrics struct {
    State             CircuitState
    FailureCount      int
    SuccessCount      int
    ConsecutiveOpens  int
    LastFailureTime   time.Time
    LastStateChange   time.Time
}

// Log state transitions
log.Infof("Circuit breaker: CLOSED → OPEN (failures: %d)", cb.failureCount)
log.Infof("Circuit breaker: OPEN → HALF_OPEN (timeout: %s)", cb.timeout)
```

## Testing Strategy

### Unit Tests (TDD)

**State Transitions:**
- Test CLOSED → OPEN on threshold
- Test OPEN → HALF_OPEN on timeout
- Test HALF_OPEN → CLOSED on success
- Test HALF_OPEN → OPEN on failure

**Threshold Behavior:**
- Test trip after N failures
- Test reset on success
- Test consecutive failure counting

**Backoff:**
- Test exponential backoff calculation
- Test max backoff cap
- Test backoff reset on success

### Integration Tests

**With Dispatcher:**
- Test circuit breaker rejects in OPEN state
- Test circuit breaker allows in CLOSED state
- Test state transitions during execution
- Test multiple workstreams with failures

**Error Scenarios:**
- Simulate agent timeout
- Simulate agent panic
- Simulate network errors
- Verify recovery after fix

## Definition of Done
- [ ] All AC verified with tests
- [ ] Unit tests ≥80% coverage
- [ ] Integration tests pass
- [ ] Circuit breaker integrated with dispatcher
- [ ] State transitions logged
- [ ] Metrics available for monitoring
- [ ] Documentation updated
- [ ] Git commit with conventional commit message
