# BEADS-001: Skills Integration

> **Epic:** Beads Integration
> **Status:** completed
> **Size:** LARGE
> **Priority:** P0 (Blocks all Beads work)
> **Note:** BEADS-001 build complete. All 5 skills integrate with Beads. Skill integration tests added (WS 00-033-02).
> **Review (2026-01-30):** APPROVED — [report](../reports/2026-01-30-BEADS-001-review.md)
> **Feature:** F032 (SDP Protocol Enforcement)

---

## Agent Routing (APPROVED)

| Item | Type | Status |
|------|------|--------|
| [001-beads-review-failing-tests](../issues/001-beads-review-failing-tests.md) | Issue | ✅ Resolved |
| [00-033-02](00-033-02-add-skill-integration-tests.md) | WS | ✅ Completed |

---

## Goal

Integrate Beads with SDP skills (@idea, @design, @build, @review, @oneshot) to enable Beads-first development workflow.

---

## Acceptance Criteria

- [x] `@idea` skill creates Beads task instead of markdown draft
- [x] `@design` skill creates sub-task graph in Beads (via `sdp beads migrate` after markdown WS)
- [x] `@build` skill works with Beads IDs and updates status (OPEN → IN_PROGRESS → CLOSED)
- [x] `@oneshot` skill uses Beads `get_ready_tasks()` for multi-agent coordination
- [x] All skills support both mock (dev) and real Beads (prod)
- [x] Backward compatibility: existing markdown workstreams still work
- [x] Documentation updated with new workflow examples (runbook, skills, .cursorrules)
- [x] Tests for all skill integrations (mock + real Beads)

---

## Context

**Problem:** Current SDP skills create markdown files in `docs/drafts/` and `docs/workstreams/`. We're migrating to Beads as primary task store.

**Solution:** Update skills to create/manipulate Beads tasks while maintaining markdown as derived artifacts (for human readability).

**Beads vs Current SDP:**

| Aspect | Current SDP | Beads |
|--------|-------------|-------|
| **Task creation** | Markdown file | `bd create` (hash ID) |
| **Dependencies** | Manual list in frontmatter | Native DAG with types |
| **Status tracking** | File location (backlog/in_progress/completed) | Status field |
| **Ready detection** | Manual | `bd ready` command |
| **Multi-agent** | Planned F012 | Built-in |

---

## Implementation Plan

### Phase 2.1: Update @idea Skill

**File:** `prompts/commands/idea.md` (or `.claude/skills/idea/SKILL.md`)

**Changes:**
1. Import BeadsClient (mock or real based on env)
2. Replace markdown draft creation with Beads task creation
3. Store generated Beads ID for reference
4. Keep markdown as optional export (for git history)

**Example workflow:**
```python
from sdp.beads import create_beads_client, BeadsTaskCreate

client = create_beads_client(use_mock=os.getenv("BEADS_USE_MOCK", "true") == "true")

def idea(skill_input: str) -> str:
    # Create Beads task instead of markdown draft
    task = client.create_task(BeadsTaskCreate(
        title=skill_input,
        description=f"Idea generated by @idea skill",
        priority=BeadsPriority.MEDIUM,
    ))

    # Optional: Export to markdown for git history
    export_to_markdown(task)

    return task.id  # Return bd-XXXX instead of file path
```

**Tests:**
- Unit test: `@idea "Add auth"` creates Beads task
- Integration test: Task has correct title, status=OPEN
- Mock test: Works without Beads installed

---

### Phase 2.2: Update @design Skill

**File:** `prompts/commands/design.md` (or `.claude/skills/design/SKILL.md`)

**Changes:**
1. Read Beads task from `@idea` output (beads_id instead of draft file)
2. Decompose into workstreams
3. Create sub-tasks in Beads with `parent_id` set
4. Create dependencies between workstreams (blocks type)
5. Export workstream list to markdown (for reference)

**Example workflow:**
```python
def design(beads_id: str) -> list[str]:
    # Read parent task
    parent_task = client.get_task(beads_id)

    # Decompose into workstreams
    workstreams = decompose_feature(parent_task.title)

    # Create sub-tasks in Beads
    ws_ids = []
    for ws in workstreams:
        ws_task = client.create_task(BeadsTaskCreate(
            title=ws.title,
            parent_id=beads_id,
            dependencies=ws.dependencies,  # BeadsDependency objects
            sdp_metadata={
                "ws_number": ws.sequence,
                "size": ws.size,
            }
        ))
        ws_ids.append(ws_task.id)

    # Export to markdown for human reference
    export_workstreams_to_markdown(parent_task, ws_ids)

    return ws_ids
```

**Tests:**
- Unit test: `@design bd-0001` creates N sub-tasks
- Integration test: Dependencies are correct
- Mock test: `get_ready_tasks()` returns first WS only

---

### Phase 2.3: Update @build Skill

**File:** `prompts/commands/build.md` (or `.claude/skills/build/SKILL.md`)

**Changes:**
1. Accept Beads task ID instead of workstream file path
2. Update task status to IN_PROGRESS before starting
3. Execute TDD cycle (Red → Green → Refactor)
4. Update task status to CLOSED on success, BLOCKED on failure
5. Trigger Beads to recalculate ready tasks (unblocks next tasks)

**Example workflow:**
```python
def build(beads_id: str) -> BuildResult:
    # Update status to IN_PROGRESS
    client.update_task_status(beads_id, BeadsStatus.IN_PROGRESS)

    try:
        # Execute TDD cycle
        result = execute_tdd_cycle(beads_id)

        if result.success:
            # Mark as done → unblocks dependent tasks
            client.update_task_status(beads_id, BeadsStatus.CLOSED)

            # Show newly ready tasks
            ready = client.get_ready_tasks()
            print(f"✅ Tasks now ready: {ready}")
        else:
            # Mark as blocked
            client.update_task_status(beads_id, BeadsStatus.BLOCKED)

        return result

    except Exception as e:
        client.update_task_status(beads_id, BeadsStatus.BLOCKED)
        raise
```

**Tests:**
- Unit test: `@build bd-0002` executes TDD
- Integration test: Status updates (OPEN → IN_PROGRESS → CLOSED)
- Mock test: Blocking task prevents dependent from being ready

---

### Phase 2.4: Update @oneshot Skill

**File:** `prompts/commands/oneshot.md` (or `.claude/skills/oneshot/SKILL.md`)

**Changes:**
1. Get feature task ID (parent)
2. Loop while `get_ready_tasks()` returns non-empty
3. Execute ready tasks in parallel (multi-agent)
4. Exit when all tasks closed

**Example workflow:**
```python
def oneshot(feature_id: str, num_agents: int = 3):
    from concurrent.futures import ThreadPoolExecutor

    with ThreadPoolExecutor(max_workers=num_agents) as executor:
        while True:
            ready = client.get_ready_tasks()

            if not ready:
                print("✅ All tasks complete!")
                break

            # Execute ready tasks in parallel
            futures = [
                executor.submit(build, task_id)
                for task_id in ready
            ]

            # Wait for all to complete
            for future in futures:
                future.result()  # Raises exceptions if any
```

**Tests:**
- Unit test: Executes 3 tasks with dependencies correctly
- Integration test: Parallel execution (Agent 1 does WS1, Agent 2 waits)
- Mock test: Blocked tasks not executed

---

### Phase 2.5: Update @review Skill

**File:** `prompts/commands/review.md` (or `.claude/skills/review/SKILL.md`)

**Changes:**
1. Accept Beads task ID instead of feature directory
2. Read all sub-tasks (workstreams) under feature
3. Validate quality gates for each
4. Update feature status based on review result

---

### Phase 2.6: Migration Helper

**New command:** `sdp beads migrate`

**Purpose:** Convert existing markdown workstreams to Beads tasks

**Implementation:**
```python
def migrate_workstreams(ws_dir: Path):
    """Convert all workstreams to Beads tasks."""
    for ws_file in ws_dir.rglob("*.md"):
        ws_data = parse_workstream(ws_file)
        result = sync.sync_workstream_to_beads(ws_file, ws_data)

        if result.success:
            print(f"✅ {ws_data['ws_id']} → {result.beads_id}")
        else:
            print(f"❌ {ws_data['ws_id']}: {result.error}")
```

---

## Files to Modify

### Skills (Primary)
- `.claude/skills/idea/SKILL.md` - Use BeadsClient instead of markdown drafts
- `.claude/skills/design/SKILL.md` - Create Beads sub-tasks with dependencies
- `.claude/skills/build/SKILL.md` - Update Beads status (IN_PROGRESS/CLOSED)
- `.claude/skills/oneshot/SKILL.md` - Use `get_ready_tasks()` for coordination
- `.claude/skills/review/SKILL.md` - Read from Beads, validate quality

### Configuration
- `.env` or `CLAUDE.md` - Add `BEADS_USE_MOCK` flag
- `pyproject.toml` - Add Beads to dependencies

### Documentation
- `CLAUDE.md` - Update with Beads workflow examples
- `README.md` - Add Beads section
- `docs/workflows/beads-first-development.md` - New workflow guide

### Tests
- `tests/integration/beads/test_skills.py` - Integration tests for skills
- `tests/unit/beads/test_sync.py` - Sync service tests

---

## Dependencies

**Blocks:**
- BEADS-002 (Real Beads Testing) - Can test with mock first
- BEADS-003 (Documentation Update) - Can update in parallel

**Blocked by:**
- None (PoC complete in BEADS-000)

---

## Definition of Done

- [x] All 5 core skills (@idea, @design, @build, @review, @oneshot) use Beads
- [x] `BEADS_USE_MOCK` environment variable controls mock vs real
- [x] Existing markdown workstreams can be migrated via `sdp beads migrate`
- [x] Multi-agent @oneshot works with 3 parallel agents
- [x] All tests pass (unit + integration)
- [x] Documentation updated (CLAUDE.md, runbook, skills, .cursorrules)
- [x] Example project demonstrates new workflow (SDP repo)
- [x] Backward compatibility maintained (markdown still works)

---

## Open Questions

1. **Should we keep markdown files?**
   - Proposal: Keep as derived artifacts (export from Beads)
   - Decision: Deferred to BEADS-003

2. **How to handle existing workstreams?**
   - Proposal: `sdp beads migrate` command
   - Manual migration for active projects
   - Decision: Implement in Phase 2.6

3. **What if Beads CLI not installed?**
   - Current: Use mock if `BEADS_USE_MOCK=true`
   - Future: Auto-detect and fallback to mock
   - Decision: Require explicit flag for now

---

## Success Metrics

| Metric | Before | After | How to Measure |
|--------|--------|-------|----------------|
| **Time to create idea** | ~30s (markdown) | ~5s (Beads) | Benchmark @idea |
| **Multi-agent setup** | Manual F012 | Auto (Beads) | Count setup steps |
| **ID conflicts** | Possible (manual PP-FFF-SS) | Impossible (hash) | Stress test |
| **Ready detection** | Manual script | `bd ready` | Feature demo |

---

---

## Related

- **BEADS-000:** Phase 1 PoC (Complete ✅)
- **BEADS-002:** Real Beads Testing (Next)
- **BEADS-003:** Documentation Update (Parallel)
- **F012:** GitHub Agent Orchestrator (To be deprecated/replaced)
